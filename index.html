<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì´ë²¤íŠ¸ ì¶”ì²¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
          font-family: 'Arial', sans-serif;
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }
      .container {
          display: flex;
          gap: 20px;
      }
      .raw-data {
          flex: 1;
          padding: 20px;
          border: 1px solid #ccc;
          border-radius: 5px;
      }
      .ranking {
          flex: 1;
          padding: 20px;
          border: 1px solid #ccc;
          border-radius: 5px;
      }
      .rank-item {
          display: flex;
          margin: 10px 0;
          padding: 10px;
          background-color: #f5f5f5;
          border-radius: 5px;
      }
      .rank-1 { background-color: #007bff; color: white; }
      .rank-2 { background-color: #ffc107; }
      .rank-3 { background-color: #28a745; color: white; }
      .rank-number {
          width: 50px;
          font-weight: bold;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          padding: 8px;
          text-align: left;
          border-bottom: 1px solid #ddd;
      }
      button {
          padding: 10px 20px;
          margin: 10px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
      }
      button:hover {
          background-color: #45a049;
      }
      .center {
          text-align: center;
      }
      #drawResult {
          margin-top: 20px;
          padding: 20px;
          background-color: #f8f9fa;
          border-radius: 5px;
          text-align: center;
          font-size: 1.2em;
      }
      .option-container {
          background-color: #f8f9fa;
          padding: 15px;
          border-radius: 5px;
          display: inline-block;
      }

      .option-container label {
          cursor: pointer;
          padding: 5px 10px;
      }

      button:disabled {
          background-color: #cccccc;
          cursor: not-allowed;
      }
      .statistics {
          margin: 20px 0;
          padding: 20px;
          background-color: #f8f9fa;
          border-radius: 5px;
      }
      .stats-container {
          display: flex;
          gap: 20px;
      }
      .stats-item {
          flex: 1;
          padding: 15px;
          background-color: white;
          border-radius: 5px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .top-participant {
          display: flex;
          justify-content: space-between;
          padding: 5px 10px;
          margin: 5px 0;
          background-color: #f5f5f5;
          border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1 class="center">ì´ë²¤íŠ¸ ì¶”ì²¨</h1>
    <div class="center">
      <input type="file" id="fileUpload" accept=".xlsx, .xls" />
      <button onclick="handleFile()">íŒŒì¼ ì½ê¸°</button>
      <div class="option-container" style="margin: 20px 0;">
        <label style="margin-right: 20px;">
          <input type="radio" name="drawOption" value="unique" />
          ì¤‘ë³µ ë‹¹ì²¨ ë°©ì§€ ëª¨ë“œ (1ì¸ 1ê²½í’ˆ)
        </label>
        <label>
          <input type="radio" name="drawOption" value="multiple" />
          ë‹¤ì¤‘ ë‹¹ì²¨ í—ˆìš© ëª¨ë“œ (1ì¸ ë‹¤ìˆ˜ ê²½í’ˆ ê°€ëŠ¥)
        </label>
      </div>
      <div
        class="option-container"
        style="margin: 20px 0; background-color: #f8f9fa; padding: 15px; border-radius: 5px;"
      >
        <label style="margin-right: 20px;">
          ë‹¹ì²¨ì ìˆ˜:
          <input
            type="number"
            id="winnerCount"
            min="1"
            value="1"
            style="width: 60px; padding: 5px;"
          />
        </label>
        <button onclick="drawRandom()" id="drawButton" disabled>
          ëœë¤ ì¶”ì²¨
        </button>
      </div>
    </div>
    <div id="drawResult"></div>
    <div id="statistics" class="statistics" style="display: none;">
      <h2>í†µê³„ ì •ë³´</h2>
      <div class="stats-container">
        <div class="stats-item">
          <h3>ê¸°ë³¸ í†µê³„</h3>
          <div id="basicStats"></div>
        </div>
        <div class="stats-item">
          <h3>ìµœë‹¤ ì°¸ì—¬ì TOP 10</h3>
          <div id="topParticipants"></div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="raw-data">
        <h2>ë¡œìš° ë°ì´í„°</h2>
        <table id="rawDataTable">
          <thead>
            <tr>
              <th>ì‘ëª¨ìˆœì„œ</th>
              <th>ì´ë©”ì¼</th>
              <th>ì‘ëª¨ íšŸìˆ˜</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="ranking">
        <h2>ìˆœìœ„í‘œ (TOP 100)</h2>
        <div id="rankingList"></div>
      </div>
    </div>

    <script>
      let excelData = [];
      let emailCounts = {}; // ì´ë©”ì¼ë³„ ì‘ëª¨ íšŸìˆ˜ë¥¼ ì €ì¥í•  ê°ì²´
      let usedEmails = new Set(); // ì´ë¯¸ ë‹¹ì²¨ëœ ì´ë©”ì¼ ì €ì¥

      function handleFile() {
          const fileUpload = document.getElementById('fileUpload');
          const file = fileUpload.files[0];

          if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, {type: 'array'});
                  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                  const range = XLSX.utils.decode_range(firstSheet['!ref']);
                  excelData = [];

                  for (let row = range.s.r + 1; row <= range.e.r; row++) {
                      const emailCell = firstSheet[XLSX.utils.encode_cell({r: row, c: 0})]; // Aì—´ (ì´ë©”ì¼)
                      const instaCell = firstSheet[XLSX.utils.encode_cell({r: row, c: 1})]; // Bì—´ (ì¸ìŠ¤íƒ€ê·¸ë¨)

                      if (emailCell && emailCell.v) {
                          excelData.push({
                              'email': emailCell.v,
                              'instagram': instaCell ? instaCell.v : '',
                              'originalRow': row
                          });
                      }
                  }

                  // ì´ë©”ì¼ë³„ ì‘ëª¨ íšŸìˆ˜ ê³„ì‚°
                  emailCounts = {};
                  excelData.forEach(item => {
                      emailCounts[item.email] = (emailCounts[item.email] || 0) + 1;
                  });

                  displayRawData();
                  updateStatistics();
                  document.getElementById('rankingList').innerHTML = '<p>ëœë¤ ì¶”ì²¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
              };
              reader.readAsArrayBuffer(file);
          } else {
              alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
          }
      }

      // ì´ë©”ì¼ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜ ì¶”ê°€
      function maskEmail(email) {
          const limit = 5;
          if (!email) return '';
          const atIndex = email.indexOf('@');
          if (atIndex <= limit) return email; // @ ê¸°í˜¸ê°€ ë„ˆë¬´ ì•ì— ìˆëŠ” ê²½ìš° ì²˜ë¦¬

          const firstThree = email.substring(0, limit);
          const restBeforeAt = '*'.repeat(atIndex - limit);
          const domain = email.substring(atIndex).split('.');
          const maskedDomain = domain.map(part => '*'.repeat(part.length)).join('.');

          return `${firstThree}${restBeforeAt}@${maskedDomain}`;
      }

      // ì¸ìŠ¤íƒ€ê·¸ë¨ ì•„ì´ë”” ë§ˆìŠ¤í‚¹ í•¨ìˆ˜ ì¶”ê°€
      function maskInstagram(instagram) {
          const limit = 3;
          if (!instagram) return '';
          if (instagram.length <= limit) return instagram;

          const firstThree = instagram.substring(0, limit);
          const restMasked = '*'.repeat(instagram.length - limit);

          return `${firstThree}${restMasked}`;
      }

      // ë¡œìš° ë°ì´í„° í‘œì‹œ í•¨ìˆ˜ ìˆ˜ì •
      function displayRawData() {
          const tbody = document.querySelector('#rawDataTable tbody');
          tbody.innerHTML = '';

          excelData.forEach((item, index) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${maskEmail(item.email)}${item.instagram ? ` / ${maskInstagram(item.instagram)}` : ''}</td>
                  <td>ì‘ëª¨ ${emailCounts[item.email]}íšŒ</td>
              `;
              tbody.appendChild(tr);
          });
      }

      // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.querySelectorAll('input[name="drawOption"]').forEach(radio => {
          radio.addEventListener('change', function() {
              document.getElementById('drawButton').disabled = false;
              if (this.value === 'unique') {
                  usedEmails.clear(); // ì˜µì…˜ ë³€ê²½ì‹œ ë‹¹ì²¨ì ëª©ë¡ ì´ˆê¸°í™”
              }
          });
      });

      function drawRandom() {
          if (excelData.length === 0) {
              alert('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì½ì–´ì£¼ì„¸ìš”!');
              return;
          }

          const drawOption = document.querySelector('input[name="drawOption"]:checked');
          if (!drawOption) {
              alert('ì¶”ì²¨ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
              return;
          }

          const winnerCount = parseInt(document.getElementById('winnerCount').value) || 1;
          if (winnerCount < 1) {
              alert('ë‹¹ì²¨ì ìˆ˜ëŠ” 1ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
              return;
          }

          // ì „ì²´ ë°°ì—´ì„ ì„ê¸°
          let shuffledData = [...excelData];
          for (let i = shuffledData.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [shuffledData[i], shuffledData[j]] = [shuffledData[j], shuffledData[i]];
          }

          if (drawOption.value === 'unique') {
              // ì¤‘ë³µ ë‹¹ì²¨ ë°©ì§€ ëª¨ë“œ
              shuffledData = shuffledData.filter(item => !usedEmails.has(item.email));
              if (shuffledData.length < winnerCount) {
                  alert(`ë‚¨ì€ ì°¸ê°€ìê°€ ${shuffledData.length}ëª… ë¿ì…ë‹ˆë‹¤. ë‹¹ì²¨ì ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”!`);
                  return;
              }
          }

          // ìˆœìœ„í‘œ ì—…ë°ì´íŠ¸
          const rankingList = document.getElementById('rankingList');
          rankingList.innerHTML = '';

          // ìƒìœ„ 100ê°œ í‘œì‹œ
          const winners = shuffledData.slice(0, 100);
          winners.forEach((row, index) => {
              const rankDiv = document.createElement('div');
              rankDiv.className = `rank-item ${index < 3 ? 'rank-' + (index + 1) : ''}`;
              rankDiv.innerHTML = `
                  <span class="rank-number">${index + 1}ë“±</span>
                  <span>${maskEmail(row['email'])}${row.instagram ? ` / ${maskInstagram(row.instagram)}` : ''} (ì´ ${emailCounts[row.email]}íšŒ ì‘ëª¨)</span>
              `;
              rankingList.appendChild(rankDiv);
          });

          // ì¤‘ë³µ ë‹¹ì²¨ ë°©ì§€ ëª¨ë“œì—ì„œëŠ” ë‹¹ì²¨ëœ ì´ë©”ì¼ ì €ì¥
          if (drawOption.value === 'unique') {
              winners.slice(0, winnerCount).forEach(winner => usedEmails.add(winner.email));
          }

          // ë¡œìš° ë°ì´í„° í…Œì´ë¸” ì—…ë°ì´íŠ¸
          displayRawData();

          // ë‹¹ì²¨ì í‘œì‹œ
          const winnersList = winners.slice(0, winnerCount)
              .map(winner => `${maskEmail(winner.email)}${winner.instagram ? ` / ${maskInstagram(winner.instagram)}` : ''}`)
              .join('<br>');

          document.getElementById('drawResult').innerHTML = `
              <h3>ğŸ‰ ë‹¹ì²¨ì ğŸ‰</h3>
              <p>${winnersList}</p>
          `;
      }

      function updateStatistics() {
          const statsDiv = document.getElementById('statistics');
          statsDiv.style.display = 'block';

          // ê¸°ë³¸ í†µê³„ ê³„ì‚°
          const uniqueParticipants = new Set(excelData.map(item => item.email)).size;
          const totalEntries = excelData.length;
          const averageEntries = (totalEntries / uniqueParticipants).toFixed(2);

          // ìµœë‹¤ ì°¸ì—¬ì ì •ë ¬
          const sortedParticipants = Object.entries(emailCounts)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 10);

          // ê¸°ë³¸ í†µê³„ í‘œì‹œ
          document.getElementById('basicStats').innerHTML = `
              <p>ì´ ì°¸ì—¬ì ìˆ˜: <strong>${uniqueParticipants}ëª…</strong></p>
              <p>ì´ ë¯¸ì…˜ ìˆ˜: <strong>${totalEntries}ê°œ</strong></p>
              <p>1ì¸ë‹¹ í‰ê·  ì°¸ì—¬ íšŸìˆ˜: <strong>${averageEntries}íšŒ</strong></p>
              <p>ì°¸ì—¬ìœ¨: <strong>${(totalEntries/uniqueParticipants).toFixed(2)}%</strong></p>
          `;

          // ìµœë‹¤ ì°¸ì—¬ì í‘œì‹œ
          const topParticipantsHTML = sortedParticipants.map((participant, index) => {
              const participantData = excelData.find(item => item.email === participant[0]) || {};
              return `
                  <div class="top-participant">
                      <span>${index + 1}. ${maskEmail(participant[0])}${participantData.instagram ? ` / ${maskInstagram(participantData.instagram)}` : ''}</span>
                      <span>ì´ ${participant[1]}íšŒ ì‘ëª¨</span>
                  </div>
              `;
          }).join('');

          document.getElementById('topParticipants').innerHTML = topParticipantsHTML;
      }
    </script>
  </body>
</html>
