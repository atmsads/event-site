<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì´ë²¤íŠ¸ ì¶”ì²¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
          font-family: 'Arial', sans-serif;
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }
      .container {
          display: flex;
          gap: 20px;
      }
      .raw-data {
          flex: 1;
          padding: 20px;
          border: 1px solid #ccc;
          border-radius: 5px;
      }
      .ranking {
          flex: 1;
          padding: 20px;
          border: 1px solid #ccc;
          border-radius: 5px;
      }
      .rank-item {
          display: flex;
          margin: 10px 0;
          padding: 10px;
          background-color: #f5f5f5;
          border-radius: 5px;
      }
      .rank-1 { background-color: #007bff; color: white; }
      .rank-2 { background-color: #ffc107; }
      .rank-3 { background-color: #28a745; color: white; }
      .rank-number {
          width: 50px;
          font-weight: bold;
      }
      table {
          width: 100%;
          border-collapse: collapse;
      }
      th, td {
          padding: 8px;
          text-align: left;
          border-bottom: 1px solid #ddd;
      }
      button {
          padding: 10px 20px;
          margin: 10px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
      }
      button:hover {
          background-color: #45a049;
      }
      .center {
          text-align: center;
      }
      #drawResult {
          margin-top: 20px;
          padding: 20px;
          background-color: #f8f9fa;
          border-radius: 5px;
          text-align: center;
          font-size: 1.2em;
      }
      .option-container {
          background-color: #f8f9fa;
          padding: 15px;
          border-radius: 5px;
          display: inline-block;
      }

      .option-container label {
          cursor: pointer;
          padding: 5px 10px;
      }

      button:disabled {
          background-color: #cccccc;
          cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1 class="center">ì´ë²¤íŠ¸ ì¶”ì²¨</h1>
    <div class="center">
      <input type="file" id="fileUpload" accept=".xlsx, .xls" />
      <button onclick="handleFile()">íŒŒì¼ ì½ê¸°</button>
      <div class="option-container" style="margin: 20px 0;">
        <label style="margin-right: 20px;">
          <input type="radio" name="drawOption" value="unique" />
          ì¤‘ë³µ ë‹¹ì²¨ ë°©ì§€ ëª¨ë“œ (1ì¸ 1ê²½í’ˆ)
        </label>
        <label>
          <input type="radio" name="drawOption" value="multiple" />
          ë‹¤ì¤‘ ë‹¹ì²¨ í—ˆìš© ëª¨ë“œ (1ì¸ ë‹¤ìˆ˜ ê²½í’ˆ ê°€ëŠ¥)
        </label>
      </div>
      <button onclick="drawRandom()" id="drawButton" disabled>ëœë¤ ì¶”ì²¨</button>
    </div>
    <div id="drawResult"></div>
    <div class="container">
      <div class="raw-data">
        <h2>ë¡œìš° ë°ì´í„°</h2>
        <table id="rawDataTable">
          <thead>
            <tr>
              <th>ì‘ëª¨ìˆœì„œ</th>
              <th>ì´ë©”ì¼</th>
              <th>ì‘ëª¨ íšŸìˆ˜</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="ranking">
        <h2>ìˆœìœ„í‘œ (TOP 100)</h2>
        <div id="rankingList"></div>
      </div>
    </div>

    <script>
      let excelData = [];
      let emailCounts = {}; // ì´ë©”ì¼ë³„ ì‘ëª¨ íšŸìˆ˜ë¥¼ ì €ì¥í•  ê°ì²´
      let usedEmails = new Set(); // ì´ë¯¸ ë‹¹ì²¨ëœ ì´ë©”ì¼ ì €ì¥

      function handleFile() {
          const fileUpload = document.getElementById('fileUpload');
          const file = fileUpload.files[0];

          if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, {type: 'array'});
                  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                  // Aì—´ì˜ ë°ì´í„°ë§Œ ì½ì–´ì˜¤ê¸°
                  const range = XLSX.utils.decode_range(firstSheet['!ref']);
                  excelData = [];

                  // ê° í–‰ì„ ìˆœíšŒí•˜ë©´ì„œ Aì—´ì˜ ë°ì´í„°ë§Œ ì¶”ì¶œ
                  for (let row = range.s.r; row <= range.e.r; row++) {
                      const cellAddress = XLSX.utils.encode_cell({r: row, c: 0}); // Aì—´ (0ë²ˆ ì—´)
                      const cell = firstSheet[cellAddress];

                      if (cell && cell.v) { // ì…€ì´ ì¡´ì¬í•˜ê³  ê°’ì´ ìˆëŠ” ê²½ìš°ë§Œ
                          const email = cell.v;
                          // ê° í–‰ì„ ê°œë³„ í•­ëª©ìœ¼ë¡œ ì¶”ê°€ (ì¤‘ë³µ ìœ ì§€)
                          excelData.push({
                              'email': email,
                              'originalRow': row + 1
                          });
                      }
                  }

                  // ì´ë©”ì¼ë³„ ì‘ëª¨ íšŸìˆ˜ ê³„ì‚°
                  emailCounts = {};
                  excelData.forEach(item => {
                      emailCounts[item.email] = (emailCounts[item.email] || 0) + 1;
                  });

                  displayRawData();
                  document.getElementById('rankingList').innerHTML = '<p>ëœë¤ ì¶”ì²¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
              };
              reader.readAsArrayBuffer(file);
          } else {
              alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
          }
      }

      function displayRawData() {
          const tbody = document.querySelector('#rawDataTable tbody');
          tbody.innerHTML = '';

          // ëª¨ë“  ë°ì´í„° í‘œì‹œ (ì¤‘ë³µ í¬í•¨)
          excelData.forEach((item, index) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${item.email}</td>
                  <td>ì‘ëª¨ ${emailCounts[item.email]}íšŒ</td>
              `;
              tbody.appendChild(tr);
          });
      }

      // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.querySelectorAll('input[name="drawOption"]').forEach(radio => {
          radio.addEventListener('change', function() {
              document.getElementById('drawButton').disabled = false;
              if (this.value === 'unique') {
                  usedEmails.clear(); // ì˜µì…˜ ë³€ê²½ì‹œ ë‹¹ì²¨ì ëª©ë¡ ì´ˆê¸°í™”
              }
          });
      });

      function drawRandom() {
          if (excelData.length === 0) {
              alert('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì½ì–´ì£¼ì„¸ìš”!');
              return;
          }

          const drawOption = document.querySelector('input[name="drawOption"]:checked');
          if (!drawOption) {
              alert('ì¶”ì²¨ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
              return;
          }

          // ì „ì²´ ë°°ì—´ì„ ì„ê¸°
          let shuffledData = [...excelData];
          for (let i = shuffledData.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [shuffledData[i], shuffledData[j]] = [shuffledData[j], shuffledData[i]];
          }

          if (drawOption.value === 'unique') {
              // ì¤‘ë³µ ë‹¹ì²¨ ë°©ì§€ ëª¨ë“œ
              shuffledData = shuffledData.filter(item => !usedEmails.has(item.email));
              if (shuffledData.length === 0) {
                  alert('ëª¨ë“  ì°¸ê°€ìê°€ ì´ë¯¸ ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!');
                  return;
              }
          }

          // ìˆœìœ„í‘œ ì—…ë°ì´íŠ¸
          const rankingList = document.getElementById('rankingList');
          rankingList.innerHTML = '';

          // ìƒìœ„ 100ê°œ í‘œì‹œ
          const winners = shuffledData.slice(0, 100);
          winners.forEach((row, index) => {
              const rankDiv = document.createElement('div');
              rankDiv.className = `rank-item ${index < 3 ? 'rank-' + (index + 1) : ''}`;
              rankDiv.innerHTML = `
                  <span class="rank-number">${index + 1}ë“±</span>
                  <span>${row['email']} (ì´ ${emailCounts[row.email]}íšŒ ì‘ëª¨)</span>
              `;
              rankingList.appendChild(rankDiv);
          });

          // ì¤‘ë³µ ë‹¹ì²¨ ë°©ì§€ ëª¨ë“œì—ì„œëŠ” ë‹¹ì²¨ëœ ì´ë©”ì¼ ì €ì¥
          if (drawOption.value === 'unique') {
              winners.forEach(winner => usedEmails.add(winner.email));
          }

          // ë¡œìš° ë°ì´í„° í…Œì´ë¸” ì—…ë°ì´íŠ¸
          displayRawData();

          // 1ë“± ë‹¹ì²¨ì í‘œì‹œ
          document.getElementById('drawResult').innerHTML = `
              <h3>ğŸ‰ ë‹¹ì²¨ì ğŸ‰</h3>
              <p>ì´ë©”ì¼: ${winners[0]['email']} (ì´ ${emailCounts[winners[0].email]}íšŒ ì‘ëª¨)</p>
          `;
      }
    </script>
  </body>
</html>
